GPU list: [0]
[
    {
        "learn_pos_emb": true,
        "tied_weights": false,
        "embedding_dim": 64,
        "transformer_dim": 64,
        "transformer_hidden_dim": 128,
        "head_dim": 32,
        "num_head": 2,
        "num_layers": 2,
        "vocab_size": 512,
        "max_seq_len": 1024,
        "dropout_prob": 0.1,
        "attention_dropout": 0.1,
        "pooling_mode": "MEAN",
        "num_classes": 14,
        "block_size": 32,
        "batch_size": 128,
        "density": 0.04,
        "mixed_precision": true,
        "random_seed": 0,
        "task": "lra-nature"
    },
    {
        "batch_size": 128,
        "learning_rate": 0.003,
        "warmup": 800,
        "lr_decay": "linear",
        "weight_decay": 0,
        "eval_frequency": 500,
        "num_train_steps": 10000,
        "num_init_steps": 3000,
        "num_eval_steps": 300,
        "num_dense_train_steps": 1000,
        "patience": 10,
        "attn_loss_scale": 0.01,
        "skewness": 1.7,
        "distnace": 1.3,
        "distance": 1.3
    }
]
attn compile
attn compile
DataParallel(
  (module): ModelForSC(
    (model): Model(
      (embeddings): Embeddings(
        (word_embeddings): Embedding(512, 64)
        (position_embeddings): Embedding(1024, 64)
        (dropout): Dropout(p=0.1, inplace=False)
      )
      (transformer_0): TransformerLayer(
        (norm1): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (mha): Attention(
          (W_q): Linear(in_features=64, out_features=64, bias=True)
          (W_k): Linear(in_features=64, out_features=64, bias=True)
          (W_v): Linear(in_features=64, out_features=64, bias=True)
          (avg_pool): AvgPool2d(kernel_size=32, stride=32, padding=0)
          (MSEloss): MSELoss()
          (attn): CUDAAttention()
          (ff): Linear(in_features=64, out_features=64, bias=True)
        )
        (dropout1): Dropout(p=0.1, inplace=False)
        (norm2): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (mlpblock): Sequential(
          (0): Linear(in_features=64, out_features=128, bias=True)
          (1): GELU(approximate='none')
          (2): Dropout(p=0.1, inplace=False)
          (3): Linear(in_features=128, out_features=64, bias=True)
          (4): Dropout(p=0.1, inplace=False)
        )
      )
      (transformer_1): TransformerLayer(
        (norm1): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (mha): Attention(
          (W_q): Linear(in_features=64, out_features=64, bias=True)
          (W_k): Linear(in_features=64, out_features=64, bias=True)
          (W_v): Linear(in_features=64, out_features=64, bias=True)
          (avg_pool): AvgPool2d(kernel_size=32, stride=32, padding=0)
          (MSEloss): MSELoss()
          (attn): CUDAAttention()
          (ff): Linear(in_features=64, out_features=64, bias=True)
        )
        (dropout1): Dropout(p=0.1, inplace=False)
        (norm2): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
        (mlpblock): Sequential(
          (0): Linear(in_features=64, out_features=128, bias=True)
          (1): GELU(approximate='none')
          (2): Dropout(p=0.1, inplace=False)
          (3): Linear(in_features=128, out_features=64, bias=True)
          (4): Dropout(p=0.1, inplace=False)
        )
      )
      (norm): LayerNorm((64,), eps=1e-05, elementwise_affine=True)
    )
    (seq_classifer): SCHead(
      (mlpblock): Sequential(
        (0): Linear(in_features=64, out_features=128, bias=True)
        (1): ReLU()
        (2): Linear(in_features=128, out_features=14, bias=True)
      )
    )
  )
)
parameter_size: [torch.Size([512, 64]), torch.Size([1024, 64]), torch.Size([64]), torch.Size([64]), torch.Size([32, 32]), torch.Size([64, 64]), torch.Size([64]), torch.Size([64, 64]), torch.Size([64]), torch.Size([64, 64]), torch.Size([64]), torch.Size([64, 64]), torch.Size([64]), torch.Size([64]), torch.Size([64]), torch.Size([128, 64]), torch.Size([128]), torch.Size([64, 128]), torch.Size([64]), torch.Size([64]), torch.Size([64]), torch.Size([32, 32]), torch.Size([64, 64]), torch.Size([64]), torch.Size([64, 64]), torch.Size([64]), torch.Size([64, 64]), torch.Size([64]), torch.Size([64, 64]), torch.Size([64]), torch.Size([64]), torch.Size([64]), torch.Size([128, 64]), torch.Size([128]), torch.Size([64, 128]), torch.Size([64]), torch.Size([64]), torch.Size([64]), torch.Size([128, 64]), torch.Size([128]), torch.Size([14, 128]), torch.Size([14])]
num_parameter: 177550
Loaded ../Skyformer/data/lra_processed/lra-nature.train.pickle... size=437513
Loaded ../Skyformer/data/lra_processed/lra-nature.dev.pickle... size=24426
Loaded ../Skyformer/data/lra_processed/lra-nature.test.pickle... size=24426
accumu_steps=1
[tensor(4.5304, device='cuda:0', grad_fn=<MseLossBackward0>), tensor(5.1571, device='cuda:0', grad_fn=<MseLossBackward0>)]
best model saved: step =  499 dev accu =  tensor(0.4030, device='cuda:0')

Validation Results
Global Steps: 499
Valid Loss: 1.77713
Valid Accuracy: 0.40302
time stamp: 129.4731249809265
module.model.transformer_0.mha.pattern saved
module.model.transformer_1.mha.pattern saved
./pickle/lra-nature/module.model.transformer_0.mha.pattern.pickle
tensor([ 660,  792,  627,  231,  759,  924,   33,  528,  264,  462,   99,  858,
         693,  363,   66,  429,  726,  297,  825,  495,  561,  891,  330,  957,
         396,  594,  198,  990,  764,  919,  243,  615, 1023,    0,  165,   35,
          97,   58,  833,  666], device='cuda:0')
tensor(40, device='cuda:0')
block_attn compile
./pickle/lra-nature/module.model.transformer_1.mha.pattern.pickle
tensor([891, 297, 495, 132, 627, 924, 693, 396,   0, 561, 429, 759, 990,  33,
        231, 825,  99, 858, 330, 303, 489, 726,  47, 481, 155, 868, 660, 629,
        691, 165, 792, 462, 264, 154, 836, 507, 879, 565, 689, 363],
       device='cuda:0')
tensor(40, device='cuda:0')
block_attn compile
total pattern searching time (s): 0.004842281341552734
total training step (k): 10.0
total training time (s): 131.8938274383545
total training time (ms): 114589.6875
peak memory usage (MB): 6988
allocated memory usage (MB): 10923794
|===========================================================================|
|                  PyTorch CUDA memory summary, device ID 0                 |
|---------------------------------------------------------------------------|
|            CUDA OOMs: 0            |        cudaMalloc retries: 0         |
|===========================================================================|
|        Metric         | Cur Usage  | Peak Usage | Tot Alloc  | Tot Freed  |
|---------------------------------------------------------------------------|
| Allocated memory      |    2077 MB |    6988 MB |   10667 GB |   10665 GB |
|       from large pool |    2072 MB |    6976 MB |   10636 GB |   10634 GB |
|       from small pool |       5 MB |      19 MB |      31 GB |      31 GB |
|---------------------------------------------------------------------------|
| Active memory         |    2077 MB |    6988 MB |   10667 GB |   10665 GB |
|       from large pool |    2072 MB |    6976 MB |   10636 GB |   10634 GB |
|       from small pool |       5 MB |      19 MB |      31 GB |      31 GB |
|---------------------------------------------------------------------------|
| GPU reserved memory   |    7592 MB |    7592 MB |    7592 MB |       0 B  |
|       from large pool |    7572 MB |    7572 MB |    7572 MB |       0 B  |
|       from small pool |      20 MB |      20 MB |      20 MB |       0 B  |
|---------------------------------------------------------------------------|
| Non-releasable memory |    1036 MB |    1105 MB |    1477 GB |    1476 GB |
|       from large pool |    1032 MB |    1100 MB |    1444 GB |    1443 GB |
|       from small pool |       4 MB |       8 MB |      32 GB |      32 GB |
|---------------------------------------------------------------------------|
| Allocations           |     275    |     537    |  299740    |  299465    |
|       from large pool |       6    |      46    |  107948    |  107942    |
|       from small pool |     269    |     530    |  191792    |  191523    |
|---------------------------------------------------------------------------|
| Active allocs         |     275    |     537    |  299740    |  299465    |
|       from large pool |       6    |      46    |  107948    |  107942    |
|       from small pool |     269    |     530    |  191792    |  191523    |
|---------------------------------------------------------------------------|
| GPU reserved segments |      31    |      31    |      31    |       0    |
|       from large pool |      21    |      21    |      21    |       0    |
|       from small pool |      10    |      10    |      10    |       0    |
|---------------------------------------------------------------------------|
| Non-releasable allocs |      17    |      29    |  159415    |  159398    |
|       from large pool |       3    |      11    |   40317    |   40314    |
|       from small pool |      14    |      22    |  119098    |  119084    |
|---------------------------------------------------------------------------|
| Oversize allocations  |       0    |       0    |       0    |       0    |
|---------------------------------------------------------------------------|
| Oversize GPU segments |       0    |       0    |       0    |       0    |
|===========================================================================|

dense memory(MB) : {} 10866968
dense step : {} 507
dense time : {} 131.09518027305603
sparse memory(MB) : {} 10921362
sparse step : {} 10
sparse_time : {} 1714022433.4322288
loading the best model from: ./checkpoints/checkpoints-0/lra-nature/tmp.model
